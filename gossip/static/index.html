<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gossip demo</title>

    <style>
        html, body {
            color: #d3d3d3;
            font: 14pt arial;
            background-color: #222222;
            height: 100%;
            margin: 0px;
        }

        #graph {
            width: 100%;
            height: 95%;
        }

        #button-container {
            text-align: center;
            font-size: xx-large;
        }

        #button {
            text-decoration: none !important;
        }

        a {
            color: #60b48a;
        }

        a:hover {
            color: #72d5a3;
        }
    </style>

    <script type="text/javascript" src="vis.js"></script>
    <link href="vis-network.min.css" rel="stylesheet" type="text/css"/>
</head>

<body>
<div id="button-container">
    <span id="loading-text">Loadingâ€¦</span>
    <a href="#" id="button" style="display: none;">Simulate Gossip!</a>
</div>
<div id="graph"></div>
<script type="text/javascript">
    var container = document.getElementById('graph');
    var data = {
        nodes: new vis.DataSet([]),
        edges: new vis.DataSet([]),
    };
    var options = {
        nodes: {
            shape: 'dot',
            size: 30,
            font: {
                size: 26,
                color: '#ffffff',
            },
            borderWidth: 2,
        },
        physics: {
        },
        interaction: {
        },
    };

    var E = {};
    function add_edge(from, to) {
        var arr = E[from];
        if (arr === undefined) {
            arr = [];
            E[from] = arr;
        }
        arr.push(to);
        data.edges.add({from: from, to: to});
    }

    const TIMEOUT_FADE = 1000;
    const TIMEOUT_SEND = 500;

    function fire(node_id) {
        data.nodes.update({id: node_id, group: 2});
        setTimeout(function() { data.nodes.update({id: node_id, group: 1}); }, TIMEOUT_FADE);
        setTimeout(function() {
            var arr = E[node_id];
            if (arr === undefined) {
                return;
            }
            for (var i = 0; i < arr.length; ++i) {
                fire(arr[i]);
            }
        }, TIMEOUT_SEND);
    }

    function ready(start_node_id) {
        var network = new vis.Network(container, data, options);
        network.on('stabilized', function() {
            document.getElementById('loading-text').style.display = 'none';
            document.getElementById('button').style.display = 'inline';
        });
        document.getElementById('button').onclick = function() { fire(start_node_id); };
    }

    function set_error(code) {
        document.getElementById('loading-text').innerHTML = 'Something went wrong (status ' + code + ')';
    }

    (function() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/network', true);
        xhr.overrideMimeType('application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState != 4) {
                return;
            }
            if (xhr.status != 200) {
                set_error(xhr.status);
                return;
            }
            var G = JSON.parse(xhr.responseText);
            var size = G.size;
            for (var i = 1; i <= size; ++i) {
                data.nodes.add({id: i, group: 1});
            }
            var edges = G.edges;
            for (var i = 0; i < edges.length; ++i) {
                var edge = edges[i];
                add_edge(edge[0], edge[1]);
            }
            ready(G.start_from);
        };
        xhr.send();
    })();

</script>
</body>
</html>
